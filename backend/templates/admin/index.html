<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>chachat Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <style>
    /* --- (æ—¢å­˜ã®CSSã¯å¤‰æ›´ãªã—) --- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Nunito:wght@400;700&display=swap');
    :root {
      --primary-color: #E6AFAF;
      --primary-gradient: linear-gradient(135deg, #F2D1C9, #E6AFAF);
      --secondary-color: #F2D1C9;
      --accent-color: #F2D1C9;
      --bg-color: #FDF0F2;
      --sidebar-bg: #FFF6F7;
      --content-bg: #ffffff;
      --text-color: #4a4a4a;
      --border-color: #EED3D3;
      --hover-bg: #F9EDEE;
      --button-text-color: #ffffff;
      --danger-color: #dc3545;
      --shadow-color: rgba(230, 175, 175, 0.13);
      --font-family: 'Nunito', 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      font-family: var(--font-family);
      margin: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: 220px;
      background-color: var(--sidebar-bg);
      padding: 20px 0;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border-color);
      border-radius: 0 16px 16px 0;
      box-shadow: 2px 0 10px var(--shadow-color);
    }
    .sidebar-header {
      padding: 0 20px 20px 20px;
      font-size: 1.4rem;
      font-weight: bold;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 15px;
      color: var(--primary-color);
      letter-spacing: 1px;
      font-family: 'Nunito', var(--font-family);
    }
    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .sidebar-menu li a {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      text-decoration: none;
      color: var(--text-color);
      border-radius: 10px;
      margin: 5px 10px;
      transition: background 0.2s, color 0.2s, transform 0.15s;
      font-weight: 500;
      font-size: 1.04em;
      font-family: 'Nunito', var(--font-family);
    }
    .sidebar-menu li a:hover, .sidebar-menu li a.active {
      background: var(--primary-gradient);
      color: var(--button-text-color);
      font-weight: 700;
      transform: translateX(6px) scale(1.05);
      box-shadow: 0 2px 8px var(--shadow-color);
    }
    .sidebar-menu li a i {
      margin-right: 12px;
      width: 20px;
      text-align: center;
    }
    .main-content {
      flex-grow: 1;
      padding: 30px;
      overflow-y: auto;
      background-color: transparent;
    }
    .content-section {
      display: none;
      animation: fadeIn 0.5s;
      background-color: var(--content-bg);
      border-radius: 16px;
      padding: 28px 24px;
      box-shadow: 0 6px 18px var(--shadow-color);
      margin: 10px 0;
    }
    .content-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    h2 {
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
      margin-bottom: 20px;
      font-size: 1.6rem;
      color: var(--primary-color);
      font-family: 'Nunito', var(--font-family);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    h3 {
      margin-top: 25px;
      margin-bottom: 15px;
      font-size: 1.18rem;
      color: #b76e79;
      font-family: 'Nunito', var(--font-family);
      font-weight: 600;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #b76e79;
      font-family: 'Nunito', var(--font-family);
    }
    input[type="text"], input[type="file"], textarea, input[type="email"], input[type="password"] {
      width: calc(100% - 24px);
      padding: 10px 12px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 0.97rem;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: #fff;
      box-shadow: inset 0 2px 4px var(--shadow-color);
    }
    input[type="text"]:focus, input[type="file"]:focus, textarea:focus, input[type="email"]:focus, input[type="password"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(183, 110, 121, 0.16);
    }
    textarea { min-height: 80px; resize: vertical; }
    button {
      padding: 10px 18px;
      background: var(--primary-gradient);
      color: var(--button-text-color);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-right: 8px;
      font-size: 1.01rem;
      font-family: 'Nunito', var(--font-family);
      font-weight: 600;
      transition: background 0.2s, opacity 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 6px var(--shadow-color);
    }
    button:hover { opacity: 0.93; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    button.secondary {
      background: var(--accent-color);
      color: #333;
      font-weight: 600;
    }
    button.secondary:hover { background: #f4dcdc; }
    button.danger {
      background: var(--danger-color);
      color: #fff;
    }
    button.danger:hover { background: #c82333; }
    .watch-btn {
      padding: 8px 14px;
      border: 2px solid var(--primary-color);
      border-radius: 10px;
      background-color: var(--secondary-color);
      font-size: .9rem;
      font-weight: 700;
      cursor: pointer;
      transition: background-color .25s, color .25s, opacity .25s;
    }
    .watch-btn.on {
      background-color: var(--primary-color);
      color: #fff;
    }
    .watch-btn.off {
      background-color: #e9dada;
      color: #6c6c6c;
      opacity:.7;
    }
    .watch-btn:hover{ opacity:.9; }
    input[type="color"] {
      width: 40px;
      height: 30px;
      padding: 0 2px;
      vertical-align: middle;
      margin-left: 10px;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    .color-setting { display: flex; align-items: center; margin-bottom: 15px; }
    .color-setting label { margin-bottom: 0; margin-right: 8px; }
    .color-value {
      font-family: monospace;
      margin-left: 5px;
      background-color: #eee;
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 0.96em;
    }
    .icon-setting-area { margin-bottom: 20px; }
    .icon-upload-area { display: flex; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;}
    .icon-upload-area label.file-select-button { margin-bottom: 0; font-weight: normal; }
    #aiIconFileInput { display: none; }
    .file-select-button {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      background-color: #eee;
      font-size: 0.95em;
      font-family: inherit;
    }
    .file-select-button:hover { background-color: #ddd; }
    #iconFileStatus { margin-left: 5px; font-size: 0.92em; font-style: italic; }
    #cropperContainer {
      width: 100%;
      max-width: 300px;
      height: 300px;
      margin-top: 10px;
      margin-bottom: 10px;
      border: 1px solid var(--border-color);
      display: none;
      background-color: #f0f0f0;
    }
    #cropperImage { display: block; max-width: 100%; }
    .crop-controls { margin-top: 10px; display: none; }
    .preview-area { margin-top: 10px; display: flex; align-items: center; gap: 10px; }
    .preview-icon {
      max-height: 40px;
      vertical-align: middle;
      display: none;
      border: 1px solid #ddd;
      padding: 2px;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 3px 6px var(--shadow-color);
      margin-left: 0;
    }
    #iconUploadStatus { font-size: 0.95em; font-style: italic; }
    .message-area {
      margin-top: 15px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid transparent;
      display: none;
      font-size: 0.97rem;
      font-weight: 500;
      background: #f9f6f7;
    }
    .info { background-color: #e2f3fe; color: #0c5464; border-color: #bce8f1; }
    .success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
    .error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 0.97rem;
      background-color: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px var(--shadow-color);
    }
    th, td {
      border: 1px solid var(--border-color);
      padding: 10px 12px;
      text-align: left;
      vertical-align: top;
      word-break: break-all;
    }
    th {
      background-color: var(--sidebar-bg);
      font-weight: 600;
      font-family: 'Nunito', var(--font-family);
      color: #b76e79;
    }
    .source-name {
      cursor: pointer;
      color: var(--primary-color);
      text-decoration: underline;
      font-weight: 600;
    }
    .source-name:hover { filter: brightness(1.2); }
    #sourceDetailContent {
      background-color: #f8f9fa;
      border: 1px solid var(--border-color);
      padding: 15px;
      margin-top: 10px;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.89rem;
      border-radius: 8px;
    }
    #sourceDetailContent img {
      max-width: 100%;
      height: auto;
      border: 1px solid #ccc;
      margin: 5px 0;
      display: block;
      border-radius: 4px;
    }
    td.actions { width: 80px; text-align: center; }
    hr { margin: 25px 0; border: 0; border-top: 1px solid #eee; }
    input:read-only:disabled { background-color: #eee; cursor: not-allowed; }
    /* Chat History Tab Styles */
    #sessionTabs > div {
      background: #fff;
      border-radius: 8px;
      margin-bottom: 6px;
      padding: 10px 14px;
      font-size: 1.01em;
      color: #b76e79;
      cursor: pointer;
      transition: background 0.15s, color 0.15s, box-shadow 0.15s;
      border: 1px solid transparent;
    }
    #sessionTabs > div:hover, #sessionTabs > div.active-session-tab {
      background: var(--primary-gradient);
      color: #fff;
      border: 1px solid var(--primary-color);
      font-weight: 700;
      box-shadow: 0 1px 5px var(--shadow-color);
    }
    /* Chat bubbles */
    #chatHistoryContainer > div {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 14px;
    }
    .chat-timestamp {
      font-size: 0.77em;
      color: #b7a4a4;
      margin-bottom: 2px;
      margin-left: 4px;
    }
    .chat-bubble {
      padding: 10px 16px;
      border-radius: 16px;
      max-width: 75%;
      font-size: 1.02em;
      background: #f3e8e8;
      color: #4a4a4a;
      box-shadow: 0 1px 3px var(--shadow-color);
      word-break: break-word;
      margin-bottom: 2px;
    }
    .chat-bubble.user {
      background: var(--primary-gradient);
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 6px;
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
      border-bottom-left-radius: 18px;
      margin-left: auto;
      margin-right: 0;
      box-shadow: 0 2px 6px var(--shadow-color);
    }
    .chat-bubble.assistant {
      background: #fff;
      color: #b76e79;
      align-self: flex-start;
      border-bottom-left-radius: 6px;
      border-top-right-radius: 18px;
      border-top-left-radius: 18px;
      border-bottom-right-radius: 18px;
      margin-right: auto;
      margin-left: 0;
      border: 1px solid var(--primary-color);
      box-shadow: 0 2px 6px var(--shadow-color);
    }
  </style>
</head>
<body>
  <div class="sidebar">
      <div class="sidebar-header">chachat Admin</div>
      <ul class="sidebar-menu">
          <li><a href="#settings" class="active" onclick="showSection('settings', this)"><i class="fa-solid fa-robot"></i> ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆè¨­å®š</a></li>
          <li><a href="#knowledge" onclick="showSection('knowledge', this)"><i class="fa-solid fa-book-medical"></i> ãƒŠãƒ¬ãƒƒã‚¸ç™»éŒ²</a></li>
          <li><a href="#sources" onclick="showSection('sources', this)"><i class="fa-solid fa-list"></i> ã‚½ãƒ¼ã‚¹ä¸€è¦§</a></li>
          <li><a href="#chat-test" onclick="showSection('chat-test', this)"><i class="fa-solid fa-message"></i> ãƒãƒ£ãƒƒãƒˆãƒ†ã‚¹ãƒˆ</a></li>
          <li><a href="#chat-history" onclick="showSection('chat-history', this)"><i class="fa-solid fa-comments"></i> ãƒãƒ£ãƒƒãƒˆå±¥æ­´</a></li>
          <li><a href="#integration" onclick="showSection('integration', this)"><i class="fa-solid fa-plug"></i> ã‚·ã‚¹ãƒ†ãƒ é€£æº</a></li>
          <li><a href="#user-settings" onclick="showSection('user-settings', this)"><i class="fa-solid fa-user-gear"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š</a></li>
      </ul>
  </div>
  <div class="main-content">
      <div id="section-settings" class="content-section active">
          <h2><i class="fa-solid fa-robot"></i> ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆè¨­å®š</h2>
          <!-- ... (æ—¢å­˜ã®ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆè¨­å®šã®ä¸­èº«ã¯å¤‰æ›´ãªã—) ... -->
          <h3>åŸºæœ¬è¨­å®š</h3>
          <div><label for="aiNameInput">AIã®åå‰:</label><input type="text" id="aiNameInput" placeholder="ä¾‹: AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ å½©"></div>
          <div class="icon-setting-area">
              <label>AIã®ã‚¢ã‚¤ã‚³ãƒ³:</label>
              <div class="icon-upload-area">
                  <label for="aiIconFileInput" class="file-select-button">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ...</label>
                  <input type="file" id="aiIconFileInput" accept="image/png, image/jpeg, image/gif, image/webp">
                  <span id="iconFileStatus"></span>
              </div>
              <div id="cropperContainer"><img id="cropperImage" src="" alt="åˆ‡ã‚ŠæŠœãå¯¾è±¡"></div>
              <div class="crop-controls"><button onclick="confirmCrop()" class="secondary">åˆ‡ã‚ŠæŠœãç¯„å›²ã‚’ç¢ºå®š</button></div>
              <div class="preview-area">
                  <label>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</label>
                  <img id="aiIconPreview" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" class="preview-icon">
                  <button onclick="uploadCroppedIcon()" id="uploadIconButton" disabled>ç¢ºå®šã—ãŸç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                  <span id="iconUploadStatus"></span>
              </div>
               <small>ï¼ˆç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸå¾Œã€ã€ŒåŸºæœ¬è¨­å®šã‚’ä¿å­˜ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰</small>
          </div>
          <div class="color-setting"><label for="themeColorHeaderInput">ãƒ˜ãƒƒãƒ€ãƒ¼è‰²:</label><span id="themeColorHeaderValue" class="color-value">#C8A2C8</span><input type="color" id="themeColorHeaderInput" value="#C8A2C8"></div>
          <div class="color-setting"><label for="themeColorUserInput">ãƒ¦ãƒ¼ã‚¶ãƒ¼å¹ãå‡ºã—è‰²:</label><span id="themeColorUserValue" class="color-value">#B76E79</span><input type="color" id="themeColorUserInput" value="#B76E79"></div>
          <div>
              <label for="initialMessageInput">åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</label>
              <textarea id="initialMessageInput" rows="3" placeholder="ãƒãƒ£ãƒƒãƒˆé–‹å§‹æ™‚ã«æœ€åˆã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"></textarea>
          </div>
          <button onclick="saveChatbotSettings()">åŸºæœ¬è¨­å®šã‚’ä¿å­˜</button>
          <div id="settingMessageArea" class="message-area"></div>
          <hr>
          <h3>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š</h3>
          <div><label for="promptRole">å½¹å‰² (Role):</label><textarea id="promptRole" placeholder="ä¾‹: ã‚ãªãŸã¯ã€‡ã€‡ä¼šç¤¾ã®è£½å“ã«ã¤ã„ã¦å›ç­”ã™ã‚‹ã‚µãƒãƒ¼ãƒˆæ‹…å½“è€…ã§ã™ã€‚"></textarea></div>
          <div><label for="promptTask">æŒ‡ç¤º (Task):</label><textarea id="promptTask" placeholder="ä¾‹: æä¾›ã•ã‚ŒãŸæƒ…å ±ã®ã¿ã«åŸºã¥ãã€ç°¡æ½”ã‹ã¤æ­£ç¢ºã«ç­”ãˆã¦ãã ã•ã„ã€‚ä¸æ˜ãªç‚¹ã¯ã€Œã‚ã‹ã‚Šã¾ã›ã‚“ã€ã¨å›ç­”ã—ã¦ãã ã•ã„ã€‚"></textarea></div>
          <button onclick="savePrompts()">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šã‚’ä¿å­˜</button>
          <div id="promptMessageArea" class="message-area"></div>
      </div>
      <div id="section-chat-history" class="content-section" style="display:flex; gap:20px;">
  
        <div id="sessionTabs" style="width:30%; padding:10px; border-right:1px solid #dee2e6; overflow-y:auto; max-height:600px;">
          <button onclick="loadChatHistory()" class="secondary" style="margin-bottom:15px;">å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€</button>
          <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ãƒ–ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        </div>
  
        <div style="width:70%; padding:10px;">
          <div id="chatHistoryContainer" style="max-height:600px; overflow-y:auto; padding:10px; border: 1px solid #dee2e6; border-radius: 6px; background-color: #f8f9fa;">
            ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚
          </div>
          <div id="chatHistoryMessageArea" class="message-area"></div>
        </div>
  
      </div>
      <div id="section-knowledge" class="content-section">
          <h2><i class="fa-solid fa-book-medical"></i> ãƒŠãƒ¬ãƒƒã‚¸ç™»éŒ²</h2>
          <!-- ... (æ—¢å­˜ã®ãƒŠãƒ¬ãƒƒã‚¸ç™»éŒ²ã®ä¸­èº«ã¯å¤‰æ›´ãªã—) ... -->
          <p>(åŒã˜ã‚½ãƒ¼ã‚¹åã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™)</p>
          <div><h3>URLã‹ã‚‰ç™»éŒ²</h3><label for="urlInput">URL:</label><input type="text" id="urlInput" placeholder="https://example.com"><button onclick="registerUrl()">URLç™»éŒ²/ä¸Šæ›¸ã</button></div>
          <hr>
          <div><h3>ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç™»éŒ²</h3><label for="fileInput">ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ (txt, pdf, docx):</label><input type="file" id="fileInput" accept=".txt,.pdf,.docx,.xls,.xlsx"><button onclick="uploadFile()">ãƒ•ã‚¡ã‚¤ãƒ«ç™»éŒ²/ä¸Šæ›¸ã</button></div>
          <hr>
          <div>
            <h3>Google Drive ã‹ã‚‰ç™»éŒ²</h3>
            <p>å…±æœ‰ãƒªãƒ³ã‚¯ï¼ˆã¾ãŸã¯ <code>file/d/FILE_ID</code> éƒ¨åˆ†ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <div style="display:flex;gap:8px;max-width:600px;">
              <input id="gdriveInput" type="text"
                     placeholder="https://drive.google.com/file/d/FILE_ID/view?usp=sharing"
                     style="flex:1;padding:8px;border:1px solid #ccc;border-radius:6px;">
              <button id="gdriveUploadBtn" class="btn btn-primary">Driveç™»éŒ²/ä¸Šæ›¸ã</button>
            </div>
            <div id="gdriveResult" style="margin-top:8px;color:#b76e79;"></div>
          </div>
          <div id="messageArea" class="message-area"></div>
      </div>
      <div id="section-sources" class="content-section">
          <h2><i class="fa-solid fa-list"></i> ã‚½ãƒ¼ã‚¹ä¸€è¦§</h2>
          <button onclick="loadSources()" class="secondary">ä¸€è¦§ã‚’æ›´æ–°</button>
          <table id="sourcesTable"><thead><tr><th>ã‚½ãƒ¼ã‚¹å (ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°)</th><th>ç™»éŒ²ãƒãƒ£ãƒ³ã‚¯æ•°</th><th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th></tr></thead><tbody id="sourcesTableBody"><tr><td colspan="3">èª­ã¿è¾¼ã¿ä¸­...</td></tr></tbody></table>
          <div id="sourceMessageArea" class="message-area"></div>
          <div id="sourceDetailArea" style="display: none;"><h3 id="sourceDetailTitle">ã‚½ãƒ¼ã‚¹è©³ç´°</h3><div id="sourceDetailContent"></div></div>
      </div>
      <!-- System Integration Section -->
      <div id="section-integration" class="content-section" style="display:none;">
          <h2><i class="fa-solid fa-plug"></i> ã‚·ã‚¹ãƒ†ãƒ é€£æº</h2>

          <h3>Slack é€£æº</h3>
          <div id="slackStatusDisplay" style="margin:12px 0;font-weight:600;">
            Slack æ¥ç¶šçŠ¶æ…‹:
            <span id="slackStatusBadge" style="padding:4px 8px;border-radius:8px;background:#e0e0e0;color:#555;">
              æœªæ¥ç¶š
            </span>
          </div>
          <button id="slackConnectBtn" class="secondary" onclick="startSlackOAuth()">
            <i class="fa-brands fa-slack"></i> Slack ã¨é€£æº
          </button>
          <div id="slackIntegrationMessage" class="message-area"></div>
          <hr>

          <!-- â–¼â–¼â–¼ Google Cookie ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â–¼â–¼â–¼ -->
          <h3><i class="fa-brands fa-google"></i> Google Cookie è¨­å®š (Google Sitesé€£æºç”¨)</h3>
          <p>éå…¬é–‹ã®Google Sitesã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸCookieãƒ•ã‚¡ã‚¤ãƒ« (Netscapeå½¢å¼ã®.txt ã¾ãŸã¯ JSONå½¢å¼ã®.json) ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç´ã¥ãã¾ã™ã€‚</p>
          <div>
              <label for="googleCookieFileInput">Cookieãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ (.txt ã¾ãŸã¯ .json):</label>
              <input type="file" id="googleCookieFileInput" accept=".txt,.json" style="margin-bottom: 8px;">
              <button onclick="uploadGoogleCookieFile()">Cookieãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
          </div>
          <div id="googleCookieMessageArea" class="message-area" style="margin-top: 10px;"></div>
          <!-- â–²â–²â–² Google Cookie ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â–²â–²â–² -->

      </div>
      <div id="section-user-settings" class="content-section">
          <h2><i class="fa-solid fa-user-gear"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š</h2>
          <div id="userSettingMessageArea" class="message-area"></div>
          <h3>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´</h3>
          <div class="form-group">
              <label for="currentEmail">ç¾åœ¨ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</label>
              <input type="text" id="currentEmail" readonly disabled>
          </div>
          <div class="form-group">
              <label for="newEmail">æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</label>
              <input type="email" id="newEmail" placeholder="æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›">
          </div>
          <button onclick="updateEmail()">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤‰æ›´</button>
          <hr>
          <h3>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
          <div class="form-group">
              <label for="currentPassword">ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
              <input type="password" id="currentPassword" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
          </div>
          <div class="form-group">
              <label for="newPassword">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
              <input type="password" id="newPassword" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
          </div>
          <div class="form-group">
              <label for="newPasswordConfirm">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (ç¢ºèª):</label>
              <input type="password" id="newPasswordConfirm" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›">
          </div>
          <button onclick="updatePassword()">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>
          <hr>
          <h3>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</h3>
          <button onclick="logoutUser()" class="danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹</button>
      </div>
    <!-- Chat Test Section -->
    <div id="section-chat-test" class="content-section" style="display:none;">
        <h2><i class="fa-solid fa-message"></i> ãƒãƒ£ãƒƒãƒˆãƒ†ã‚¹ãƒˆ</h2>
        <iframe src="/" style="width:100%;height:650px;border:1px solid #dee2e6;border-radius:8px;"></iframe>
    </div>
  </div>

  <script>
    // --- API Base (sameâ€‘origin) ---
    const apiUrlBase = "";  // if backend served at same host, empty string works

    // --- DOM element references & globals ---
    const aiNameInput            = document.getElementById('aiNameInput');
    const themeColorHeaderInput  = document.getElementById('themeColorHeaderInput');
    const themeColorUserInput    = document.getElementById('themeColorUserInput');
    const promptRoleInput        = document.getElementById('promptRole');
    const promptTaskInput        = document.getElementById('promptTask');
    const initialMessageInput    = document.getElementById('initialMessageInput');

    const aiIconFileInput        = document.getElementById('aiIconFileInput');
    const iconFileStatus         = document.getElementById('iconFileStatus');
    const cropperContainer       = document.getElementById('cropperContainer');
    const cropperImage           = document.getElementById('cropperImage');
    const cropControls           = document.querySelector('.crop-controls');
    const aiIconPreview          = document.getElementById('aiIconPreview');
    const uploadIconButton       = document.getElementById('uploadIconButton');

    const userSettingMessageArea = document.getElementById('userSettingMessageArea');
    const currentEmailInput      = document.getElementById('currentEmail');
    const settingMessageArea     = document.getElementById('settingMessageArea');
    const messageArea            = document.getElementById('messageArea');
    const promptMessageArea      = document.getElementById('promptMessageArea');
    const sourceMessageArea      = document.getElementById('sourceMessageArea');
    const sourcesTableBody       = document.getElementById('sourcesTableBody');
    const sourceDetailArea       = document.getElementById('sourceDetailArea');
    const sourceDetailTitle      = document.getElementById('sourceDetailTitle');
    const sourceDetailContent    = document.getElementById('sourceDetailContent');

    // Cropper.js helper globals
    let cropper = null;          // will hold Cropper instance
    let croppedImageBlob = null; // holds Blob after cropping

    // ... (æ—¢å­˜ã®è¦ç´ å–å¾—) ...
    const googleCookieFileInput = document.getElementById('googleCookieFileInput'); // è¿½åŠ 
    const googleCookieMessageArea = document.getElementById('googleCookieMessageArea'); // è¿½åŠ 

    // --- (æ—¢å­˜ã®JavaScriptã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥) ---
    // --- ç”»é¢åˆ‡ã‚Šæ›¿ãˆé–¢æ•° (å¤‰æ›´ãªã—) ---
    function showSection(sectionId, clickedLink) {
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
            section.style.display = 'none';
        });
        const activeSection = document.getElementById(`section-${sectionId}`);
        if (activeSection) {
            activeSection.classList.add('active');
            activeSection.style.display = (sectionId === 'chat-history') ? 'flex' : 'block';
        }
        document.querySelectorAll('.sidebar-menu li a').forEach(link => link.classList.remove('active'));
        if (clickedLink) clickedLink.classList.add('active');
        if (sectionId === 'user-settings') { loadCurrentUserInfo(); }
        else if (sectionId === 'sources') { loadSources(); }
        else if (sectionId === 'settings') { loadChatbotSettings(); loadPrompts(); }
        else if (sectionId === 'chat-history') { loadChatHistory(); }
        else if (sectionId === 'chat-test') { /* no extra init needed */ }
        else if (sectionId === 'integration') {
            loadSlackStatus();
        }
    }

    // --- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•° (å¤‰æ›´ãªã—) ---
    function showMessage(areaElement, message, type = 'info', duration = 5000) {
        if (!areaElement) { console.warn("showMessage: areaElement not found for message:", message); return; }
        areaElement.textContent = message; areaElement.className = `message-area ${type}`; areaElement.style.display = 'block';
        requestAnimationFrame(() => { if (type !== 'error' && duration > 0) { setTimeout(() => { if (areaElement.textContent === message) { areaElement.style.display = 'none'; areaElement.textContent = '';}}, duration); }});
    }

    // --- ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­ã¿è¾¼ã¿é–¢æ•° (å¤‰æ›´ãªã—) ---
    async function loadCurrentUserInfo() {
        showMessage(userSettingMessageArea, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­è¾¼ä¸­...', 'info', 0);
        try {
            const res = await fetch(`${apiUrlBase}/api/user/info`);
            const data = await res.json();
            if (res.ok && data.status === 'ok') {
                currentEmailInput.value = data.email || 'å–å¾—å¤±æ•—';
                showMessage(userSettingMessageArea, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­ã¿è¾¼ã¿å®Œäº†', 'success');
            } else {
                currentEmailInput.value = 'å–å¾—å¤±æ•—';
                showMessage(userSettingMessageArea, `ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­è¾¼ã‚¨ãƒ©ãƒ¼: ${data.message || 'ä¸æ˜'}`, 'error');
            }
        } catch (error) {
            currentEmailInput.value = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼';
            showMessage(userSettingMessageArea, `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error}`, 'error');
            console.error("Load User Info Error:", error);
        }
    }

    // --- ãƒŠãƒ¬ãƒƒã‚¸ç™»éŒ²é–¢é€£ (å¤‰æ›´ãªã—) ---
    async function registerUrl() { const urlInput = document.getElementById('urlInput'); const url = urlInput.value.trim(); if (!url) { showMessage(messageArea, 'URLå…¥åŠ›', 'error'); return; } showMessage(messageArea, 'URLå‡¦ç†ä¸­...', 'info', 0); urlInput.disabled = true; try { const res = await fetch(`${apiUrlBase}/api/url`, { method: 'POST', headers: { 'Content-Type': 'application/json'}, body: JSON.stringify({ url }) }); const data = await res.json(); if (res.ok && data.status === 'ok') { showMessage(messageArea, data.message || 'URLç™»éŒ²/ä¸Šæ›¸ãæˆåŠŸ', 'success'); urlInput.value = ''; if (document.getElementById('section-sources').classList.contains('active')) loadSources(); } else { showMessage(messageArea, `URLã‚¨ãƒ©ãƒ¼: ${data.message || res.statusText || 'ä¸æ˜'}`, 'error'); } } catch (error) { showMessage(messageArea, `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error}`, 'error'); console.error("URL Reg Error:", error); } finally { urlInput.disabled = false; } }
    async function uploadFile() { const fileInput = document.getElementById('fileInput'); const file = fileInput.files[0]; if (!file) { showMessage(messageArea, 'ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ', 'error'); return; } showMessage(messageArea, 'ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ä¸­...', 'info', 0); fileInput.disabled = true; const formData = new FormData(); formData.append('file', file); try { const res = await fetch(`${apiUrlBase}/api/upload`, { method: 'POST', body: formData }); const data = await res.json(); if (res.ok && data.status === 'ok') { showMessage(messageArea, data.message || 'ãƒ•ã‚¡ã‚¤ãƒ«ç™»éŒ²/ä¸Šæ›¸ãæˆåŠŸ', 'success'); fileInput.value = ''; if (document.getElementById('section-sources').classList.contains('active')) loadSources(); } else { showMessage(messageArea, `ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼: ${data.message || res.statusText || 'ä¸æ˜'}`, 'error'); } } catch (error) { showMessage(messageArea, `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error}`, 'error'); console.error("File Up Error:", error); } finally { fileInput.disabled = false; } }

    // --- Google Drive upload (auto detect doc/sheet) ---
    document.getElementById("gdriveUploadBtn").addEventListener("click", async () => {
        const input  = document.getElementById("gdriveInput");
        const status = document.getElementById("gdriveResult");
        status.textContent = "";
        let link = input.value.trim();
        if (!link) { status.textContent = "ãƒªãƒ³ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"; return; }

        const m = link.match(/\/(?:spreadsheets\/|document\/|file\/)?d\/([A-Za-z0-9_-]{10,})/);
        const fileId = m ? m[1] : link;
        if (!fileId) { status.textContent = "ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"; return; }

        const endpoint = link.includes("/spreadsheets/")
            ? "/api/google/sheet"
            : "/api/google/doc";

        status.textContent = "ç™»éŒ²ä¸­â€¦";
        try {
            const res  = await fetch(`${apiUrlBase}${endpoint}`, {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ file_id: fileId })
            });
            const data = await res.json();
            if (res.ok && data.status === "ok") {
                status.style.color = "green";
                status.textContent = "Google ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™»éŒ²ã—ã¾ã—ãŸ ğŸ‰";
                input.value = "";
                if (document.getElementById('section-sources').classList.contains('active')) {
                    loadSources();
                }
            } else {
                status.style.color = "red";
                status.textContent = data.message || "ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            }
        } catch (e) {
            console.error(e);
            status.style.color = "red";
            status.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
        }
    });

    // --- ã‚½ãƒ¼ã‚¹ä¸€è¦§é–¢é€£ (å¤‰æ›´ãªã—) ---
    async function loadSources() { showMessage(sourceMessageArea, 'ã‚½ãƒ¼ã‚¹å–å¾—ä¸­...', 'info', 0); sourcesTableBody.innerHTML = '<tr><td colspan="3">èª­è¾¼ä¸­...</td></tr>'; sourceDetailArea.style.display = 'none'; try { const res = await fetch(`${apiUrlBase}/api/sources`, { credentials: "include" }); const data = await res.json(); if (res.ok && data.status === 'ok') { sourcesTableBody.innerHTML = ''; const sources = data.sources; if (Object.keys(sources).length === 0) { sourcesTableBody.innerHTML = '<tr><td colspan="3">ç™»éŒ²ã‚½ãƒ¼ã‚¹ãªã—</td></tr>'; showMessage(sourceMessageArea, 'ç™»éŒ²ã‚½ãƒ¼ã‚¹ãªã—', 'info'); } else { const sortedSources = Object.entries(sources).sort((a, b) => a[0].localeCompare(b[0])); for (const [sourceName, chunkCount] of sortedSources) { const row = sourcesTableBody.insertRow(); const cell1 = row.insertCell(); const cell2 = row.insertCell(); const cell3 = row.insertCell(); const sourceLink = document.createElement('span'); sourceLink.className = 'source-name'; sourceLink.textContent = sourceName; sourceLink.onclick = () => showSourceDetails(sourceName); cell1.appendChild(sourceLink); cell2.textContent = chunkCount; cell3.classList.add('actions'); const deleteButton = document.createElement('button'); deleteButton.textContent = 'å‰Šé™¤'; deleteButton.className = 'danger'; deleteButton.onclick = () => deleteSource(sourceName); cell3.appendChild(deleteButton); if (sourceName.startsWith("gsheet:")) { const watchBtn = document.createElement('button'); watchBtn.textContent = 'ç›£è¦–'; watchBtn.className = 'watch-btn off'; const fileId = sourceName.slice(7); watchBtn.onclick = (ev) => toggleWatch(ev, fileId); cell3.appendChild(watchBtn); } } showMessage(sourceMessageArea, `ä¸€è¦§æ›´æ–° (${Object.keys(sources).length}ä»¶)`, 'success'); } } else { showMessage(sourceMessageArea, `ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼: ${data.message || res.statusText || 'ä¸æ˜'}`, 'error'); sourcesTableBody.innerHTML = '<tr><td colspan="3">ä¸€è¦§å–å¾—å¤±æ•—</td></tr>'; } } catch (error) { showMessage(sourceMessageArea, `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error}`, 'error'); sourcesTableBody.innerHTML = '<tr><td colspan="3">ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼</td></tr>'; console.error("Load Src Error:", error); } }
    async function showSourceDetails(sourceName) { if (sourceName.startsWith("gsheet:")) { const fileId = sourceName.slice(7); previewSheet(fileId); return; } console.log("--- showSourceDetails ---"); console.log("Original sourceName:", sourceName); sourceDetailTitle.textContent = `ã‚½ãƒ¼ã‚¹è©³ç´°: ${sourceName}`; sourceDetailContent.innerHTML = '<div>èª­è¾¼ä¸­...</div>'; sourceDetailArea.style.display = 'block'; const encodedSourceName = encodeURIComponent(sourceName); console.log("Encoded sourceName for API call:", encodedSourceName); const limit = 50; try { const res = await fetch(`${apiUrlBase}/api/documents/${encodedSourceName}?limit=${limit}`, { credentials: "include" }); console.log("API Response Status:", res.status); const data = await res.json(); console.log("Full API Response Data:", data); if (res.ok && data.status === 'ok' && data.documents) { const documents = data.documents; console.log(`Received ${documents.length} documents from API.`); if (documents.length > 0) { sourceDetailContent.innerHTML = `<h4>å–å¾—ãƒãƒ£ãƒ³ã‚¯ (æœ€å¤§${limit}ä»¶):</h4>`; documents.forEach((doc, index) => { const chunkDiv = document.createElement('div'); chunkDiv.style.borderTop = '1px dashed #ccc'; chunkDiv.style.marginTop = '10px'; chunkDiv.style.paddingTop = '10px'; const chunkTitle = document.createElement('h5'); chunkTitle.textContent = `--- ãƒãƒ£ãƒ³ã‚¯ ${index + 1} ---`; chunkDiv.appendChild(chunkTitle); const processedDoc = doc.replace(/\[ç”»åƒ(?::\s*([^\]\n]+?))?\](?:\(([^)\n]+?)\))?/g, (match, altText, imgSrc) => { const alt = altText ? altText.trim() : ' '; if (imgSrc && imgSrc.trim().toLowerCase().startsWith('http')) { return `<img src="${imgSrc.trim()}" alt="${alt}" title="${alt}" loading="lazy">`; } else if (alt.trim()) { return `[ç”»åƒ: ${alt}]`; } else { return `[ç”»åƒ]`; } }); const contentPre = document.createElement('pre'); contentPre.style.whiteSpace = 'pre-wrap'; contentPre.style.wordWrap = 'break-word'; contentPre.innerHTML = processedDoc; chunkDiv.appendChild(contentPre); sourceDetailContent.appendChild(chunkDiv); }); } else { sourceDetailContent.textContent = 'é–¢é€£ãƒãƒ£ãƒ³ã‚¯ãªã— (ãƒ‡ãƒ¼ã‚¿0ä»¶)'; console.log("API returned success but documents array is empty."); } } else { sourceDetailContent.textContent = `ãƒãƒ£ãƒ³ã‚¯å–å¾—ã‚¨ãƒ©ãƒ¼: ${data.message || (res.ok ? 'ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ä¸æ­£' : res.statusText) || 'ä¸æ˜'}`; sourceDetailContent.style.color = '#721c24'; console.error("API Error or Invalid Response Format:", data); } } catch (error) { sourceDetailContent.textContent = `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error}`; sourceDetailContent.style.color = '#721c24'; console.error("Fetch Error in showSourceDetails:", error); } }
    async function deleteSource(sourceName) { if (!confirm(`ã‚½ãƒ¼ã‚¹ã€Œ${sourceName}ã€å‰Šé™¤ï¼Ÿ`)) { return; } showMessage(sourceMessageArea, `ã‚½ãƒ¼ã‚¹å‰Šé™¤ä¸­: ${sourceName}`, 'info', 0); const encodedSourceName = encodeURIComponent(sourceName); try { const res = await fetch(`${apiUrlBase}/api/sources/${encodedSourceName}`, { method: 'DELETE', credentials: "include" }); const data = await res.json(); if (res.ok && data.status === 'ok') { showMessage(sourceMessageArea, data.message || 'å‰Šé™¤æˆåŠŸ', 'success'); sourceDetailArea.style.display = 'none'; loadSources(); } else { showMessage(sourceMessageArea, `å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${data.message || res.statusText || 'ä¸æ˜'}`, 'error'); } } catch (error) { showMessage(sourceMessageArea, `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error}`, 'error'); console.error("Del Src Error:", error); } }

    // --- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šé–¢é€£ (å¤‰æ›´ãªã—) ---
    async function loadPrompts() { showMessage(promptMessageArea, 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­è¾¼ä¸­...', 'info', 0); try{ const res = await fetch(`${apiUrlBase}/api/prompts`, { credentials: "include" }); const data = await res.json(); if (res.ok && data.status === 'ok'){ promptRoleInput.value = data.prompts.role || ''; promptTaskInput.value = data.prompts.task || ''; showMessage(promptMessageArea, 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­è¾¼å®Œäº†', 'success'); } else { showMessage(promptMessageArea, `èª­è¾¼ã‚¨ãƒ©ãƒ¼: ${data.message || res.statusText || 'ä¸æ˜'}`, 'error'); }} catch(error){ showMessage(promptMessageArea, `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error}`, 'error'); console.error("Load Prompts Error:", error); } }
    async function savePrompts() { const role = promptRoleInput.value; const task = promptTaskInput.value; showMessage(promptMessageArea, 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜ä¸­...', 'info', 0); try{ const res = await fetch(`${apiUrlBase}/api/prompts`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ role, task }) }); const data = await res.json(); if (res.ok && data.status === 'ok'){ showMessage(promptMessageArea, data.message || 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜å®Œäº†', 'success'); } else { showMessage(promptMessageArea, `ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${data.message || res.statusText || 'ä¸æ˜'}`, 'error'); }} catch(error){ showMessage(promptMessageArea, `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error}`, 'error'); console.error("Save Prompts Error:", error); } }

    // --- ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆè¨­å®šé–¢é€£ (å¤‰æ›´ãªã—) ---
    async function loadChatbotSettings() { showMessage(settingMessageArea, 'ãƒãƒ£ãƒƒãƒˆè¨­å®šèª­è¾¼ä¸­...', 'info', 0); try { const res = await fetch(`${apiUrlBase}/api/settings`, { credentials: "include" }); const data = await res.json(); if (res.ok && data.status === 'ok' && data.settings) { const s = data.settings; aiNameInput.value = s.ai_name || ''; themeColorHeaderInput.value = s.theme_color_header || '#C8A2C8'; themeColorUserInput.value = s.theme_color_user || '#B76E79'; const initialMsgInput = document.getElementById('initialMessageInput'); if (initialMsgInput) initialMsgInput.value = s.initial_message || ''; updateColorValue('themeColorHeaderValue', themeColorHeaderInput.value); updateColorValue('themeColorUserValue', themeColorUserInput.value); resetIconArea(s.ai_icon_url || ''); showMessage(settingMessageArea, 'ãƒãƒ£ãƒƒãƒˆè¨­å®šèª­è¾¼å®Œäº†', 'success'); } else { showMessage(settingMessageArea, `èª­è¾¼ã‚¨ãƒ©ãƒ¼: ${data.message || res.statusText || 'ä¸æ˜'}`, 'error'); resetIconArea(); } } catch (error) { showMessage(settingMessageArea, `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error}`, 'error'); console.error("Load Settings Error:", error); resetIconArea(); } }
    async function saveChatbotSettings() { const iconUrl = '/static/icons/ai_icon.png'; const initialMsgInput = document.getElementById('initialMessageInput'); const initialMessageValue = initialMsgInput ? initialMsgInput.value.trim() : ''; const settings = { ai_name: aiNameInput.value.trim(), ai_icon_url: iconUrl, theme_color_header: themeColorHeaderInput.value, theme_color_user: themeColorUserInput.value, initial_message: initialMessageValue }; if (!settings.ai_name){ showMessage(settingMessageArea, 'AIåå…¥åŠ›å¿…é ˆ', 'error'); return; } if (!settings.theme_color_header.match(/^#[0-9a-fA-F]{6}$/)){ showMessage(settingMessageArea, 'ãƒ˜ãƒƒãƒ€ãƒ¼è‰²ä¸æ­£', 'error'); return; } if (!settings.theme_color_user.match(/^#[0-9a-fA-F]{6}$/)){ showMessage(settingMessageArea, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼è‰²ä¸æ­£', 'error'); return; } if(!settings.initial_message){ showMessage(settingMessageArea, 'åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›å¿…é ˆ', 'error'); return;} showMessage(settingMessageArea, 'ãƒãƒ£ãƒƒãƒˆè¨­å®šä¿å­˜ä¸­...', 'info', 0); try { const res = await fetch(`${apiUrlBase}/api/settings`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(settings) }); const data = await res.json(); if (res.ok && data.status === 'ok'){ showMessage(settingMessageArea, data.message || 'ãƒãƒ£ãƒƒãƒˆè¨­å®šä¿å­˜å®Œäº†', 'success'); } else { showMessage(settingMessageArea, `ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${data.message || res.statusText || 'ä¸æ˜'}`, 'error'); } } catch(error){ showMessage(settingMessageArea, `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error}`, 'error'); console.error("Save Settings Error:", error); } }

    // --- ã‚¢ã‚¤ã‚³ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢é€£ (å¤‰æ›´ãªã—) ---
    aiIconFileInput.addEventListener('change', handleIconFileSelect);
    function handleIconFileSelect(event) { const file = event.target.files[0]; iconFileStatus.textContent = file ? file.name : ''; croppedImageBlob = null; uploadIconButton.disabled = true; iconUploadStatus.textContent = ''; aiIconPreview.style.display = 'none'; if (cropper) { cropper.destroy(); cropper = null; } cropperContainer.style.display = 'none'; cropControls.style.display = 'none'; if (file && file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = (e) => { if (cropper) { cropper.destroy(); cropper = null;} cropperImage.src = e.target.result; try { cropper = new Cropper(cropperImage, { aspectRatio: 1 / 1, viewMode: 1, dragMode: 'move', background: false, autoCropArea: 0.8, ready: function(){ cropperContainer.style.display = 'block'; cropControls.style.display = 'block'; } }); } catch(cropperError) { console.error("Cropper init error:", cropperError); showMessage(settingMessageArea, 'ç”»åƒç·¨é›†åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼', 'error'); resetIconArea(); } }; reader.onerror = (e) => { console.error("FileReader error:", e); showMessage(settingMessageArea, 'ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼å¤±æ•—', 'error'); resetIconArea(); }; reader.readAsDataURL(file); } else { if (file) { iconUploadStatus.textContent = 'ç”»åƒé¸æŠè¦'; iconUploadStatus.style.color = 'red'; }} }
    function confirmCrop() { if (!cropper) return; try { const canvas = cropper.getCroppedCanvas({ width: 256, height: 256, imageSmoothingQuality: 'high' }); if (!canvas) { throw new Error("Canvaså–å¾—å¤±æ•—"); } canvas.toBlob((blob) => { if (blob) { croppedImageBlob = blob; const previewUrl = URL.createObjectURL(blob); aiIconPreview.src = previewUrl; aiIconPreview.style.display = 'inline-block'; uploadIconButton.disabled = false; iconUploadStatus.textContent = 'åˆ‡æŠœå®Œäº†ã€‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯'; iconUploadStatus.style.color = 'green'; cropperContainer.style.display = 'none'; cropControls.style.display = 'none'; if (cropper) {cropper.destroy(); cropper = null;} } else { console.error("Blobä½œæˆå¤±æ•—"); iconUploadStatus.textContent = 'åˆ‡æŠœå‡¦ç†å¤±æ•—'; iconUploadStatus.style.color = 'red'; uploadIconButton.disabled = true; } }, 'image/png', 0.9); } catch(cropError) { console.error("Crop confirm error:", cropError); showMessage(settingMessageArea, `åˆ‡æŠœã‚¨ãƒ©ãƒ¼: ${cropError.message}`, 'error'); uploadIconButton.disabled = true; } }
    async function uploadCroppedIcon() { if (!croppedImageBlob) { showMessage(settingMessageArea, 'å…ˆã«ç”»åƒã‚’åˆ‡æŠœç¢ºå®š', 'error'); return; } const formData = new FormData(); formData.append('icon_file', croppedImageBlob, 'ai_icon.png'); showMessage(settingMessageArea, 'ã‚¢ã‚¤ã‚³ãƒ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'info', 0); uploadIconButton.disabled = true; iconUploadStatus.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...'; try { const res = await fetch(`${apiUrlBase}/api/upload_icon`, { method: 'POST', body: formData }); const data = await res.json(); if (res.ok && data.status === 'ok') { showMessage(settingMessageArea, data.message || 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸï¼è¨­å®šã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚', 'success'); if(data.icon_url){ aiIconPreview.src = data.icon_url; aiIconPreview.style.display = 'inline-block'; } aiIconFileInput.value = ''; iconFileStatus.textContent = ''; croppedImageBlob = null; iconUploadStatus.textContent = 'å®Œäº†'; iconUploadStatus.style.color = 'green'; } else { showMessage(settingMessageArea, `ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${data.message || res.statusText || 'ä¸æ˜'}`, 'error'); iconUploadStatus.textContent = 'å¤±æ•—'; iconUploadStatus.style.color = 'red'; } } catch (error) { showMessage(settingMessageArea, `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error}`, 'error'); iconUploadStatus.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼'; iconUploadStatus.style.color = 'red'; console.error("Upload Icon Error:", error); } finally { uploadIconButton.disabled = true; } }
    function resetIconArea(defaultIconUrl = '') { if (cropper) { cropper.destroy(); cropper = null; } cropperContainer.style.display = 'none'; cropControls.style.display = 'none'; aiIconFileInput.value = ''; iconFileStatus.textContent = ''; croppedImageBlob = null; uploadIconButton.disabled = true; iconUploadStatus.textContent = ''; const iconUrlToDisplay = defaultIconUrl && defaultIconUrl.startsWith('/static/icons') ? `${defaultIconUrl}?t=${Date.now()}` : ''; aiIconPreview.src = iconUrlToDisplay; aiIconPreview.style.display = iconUrlToDisplay ? 'inline-block' : 'none'; aiIconPreview.onerror = () => { console.warn("Failed icon preview:", iconUrlToDisplay); aiIconPreview.style.display = 'none'; aiIconPreview.src='';}; }

    // --- ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ (å¤‰æ›´ãªã—) ---
    function updateColorValue(elementId, value) { const span = document.getElementById(elementId); if (span) span.textContent = value; }
    themeColorHeaderInput.addEventListener('input', (e) => updateColorValue('themeColorHeaderValue', e.target.value));
    themeColorUserInput.addEventListener('input', (e) => updateColorValue('themeColorUserValue', e.target.value));

    // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šé–¢é€£ã®æ–°ã—ã„é–¢æ•° (å¤‰æ›´ãªã—) ---
    async function updateEmail() { const newEmail = newEmailInput.value.trim(); if (!newEmail) { showMessage(userSettingMessageArea, 'æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error'); return; } if (!/\S+@\S+\.\S+/.test(newEmail)) { showMessage(userSettingMessageArea, 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error'); return; } showMessage(userSettingMessageArea, 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´ä¸­...', 'info', 0); try { const res = await fetch(`${apiUrlBase}/api/user/update_email`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ new_email: newEmail }) }); const data = await res.json(); if (res.ok && data.status === 'ok') { showMessage(userSettingMessageArea, data.message || 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚', 'success'); currentEmailInput.value = newEmail; newEmailInput.value = ''; } else { showMessage(userSettingMessageArea, `å¤‰æ›´ã‚¨ãƒ©ãƒ¼: ${data.message || 'ä¸æ˜'}`, 'error'); } } catch (error) { showMessage(userSettingMessageArea, `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error}`, 'error'); console.error("Update Email Error:", error); } }
    async function updatePassword() { const currentPassword = currentPasswordInput.value; const newPassword = newPasswordInput.value; const newPasswordConfirm = newPasswordConfirmInput.value; if (!currentPassword || !newPassword || !newPasswordConfirm) { showMessage(userSettingMessageArea, 'ã™ã¹ã¦ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¬„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error'); return; } if (newPassword !== newPasswordConfirm) { showMessage(userSettingMessageArea, 'æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚', 'error'); return; } if (newPassword.length < 6) { showMessage(userSettingMessageArea, 'æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„ã€‚', 'error'); return; } showMessage(userSettingMessageArea, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ä¸­...', 'info', 0); try { const res = await fetch(`${apiUrlBase}/api/user/update_password`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ current_password: currentPassword, new_password: newPassword, new_password_confirm: newPasswordConfirm }) }); const data = await res.json(); if (res.ok && data.status === 'ok') { showMessage(userSettingMessageArea, data.message || 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚', 'success'); currentPasswordInput.value = ''; newPasswordInput.value = ''; newPasswordConfirmInput.value = ''; } else { showMessage(userSettingMessageArea, `å¤‰æ›´ã‚¨ãƒ©ãƒ¼: ${data.message || 'ä¸æ˜'}`, 'error'); } } catch (error) { showMessage(userSettingMessageArea, `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error}`, 'error'); console.error("Update Password Error:", error); } }
    function logoutUser() { if (confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) { window.location.href = '/logout'; } }

    // --- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ (å¤‰æ›´ãªã—) ---
    async function loadChatHistory() {
      const messageArea = document.getElementById('chatHistoryMessageArea');
      const chatContainer = document.getElementById('chatHistoryContainer');
      const sessionTabs = document.getElementById('sessionTabs');
      showMessage(messageArea, 'ãƒãƒ£ãƒƒãƒˆå±¥æ­´å–å¾—ä¸­...', 'info', 0);
      chatContainer.innerHTML = 'èª­ã¿è¾¼ã¿ä¸­...';
      sessionTabs.innerHTML = ''; // ãƒœã‚¿ãƒ³ã‚‚ã‚¯ãƒªã‚¢
      const loadButton = document.createElement('button');
      loadButton.textContent = 'å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€';
      loadButton.className = 'secondary';
      loadButton.style.marginBottom = '15px';
      loadButton.onclick = loadChatHistory; // è‡ªåˆ†è‡ªèº«ã‚’å†åº¦å‘¼ã³å‡ºã™
      sessionTabs.appendChild(loadButton);
      try {
        const res = await fetch(`${apiUrlBase}/api/chat_history`, { credentials: "include" });
        const data = await res.json();
        if (res.ok && data.status === 'ok') {
          const sessions = data.sessions;
          chatContainer.innerHTML = '';
          // æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ãƒ–ã‚’ã‚¯ãƒªã‚¢ (ãƒœã‚¿ãƒ³ã¯æ®‹ã™)
          const existingTabs = sessionTabs.querySelectorAll('div');
          existingTabs.forEach(tab => tab.remove());

          if (sessions.length === 0) {
            chatContainer.innerHTML = 'ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
            showMessage(messageArea, 'ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“', 'info');
          } else {
            sessions.reverse(); // æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä¸Šã«æ¥ã‚‹ã‚ˆã†ã«
            sessions.forEach((session, idx) => {
              const sessionStartTime = session[0].timestamp;
              const tabDiv = document.createElement('div');
              tabDiv.textContent = `${sessionStartTime} (ä¼šè©±æ•°: ${session.length})`;
              tabDiv.onclick = () => displaySession(session, tabDiv);
              sessionTabs.appendChild(tabDiv);
              if (idx === 0) { displaySession(session, tabDiv); }
            });
            showMessage(messageArea, `ãƒãƒ£ãƒƒãƒˆå±¥æ­´å–å¾—å®Œäº† (${sessions.length}ã‚»ãƒƒã‚·ãƒ§ãƒ³)`, 'success');
          }
        } else { throw new Error(data.message || 'å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
      } catch (error) {
        showMessage(messageArea, `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        chatContainer.innerHTML = 'å–å¾—ã‚¨ãƒ©ãƒ¼';
      }
    }
    function displaySession(session, clickedTabElement) {
      const chatContainer = document.getElementById('chatHistoryContainer');
      chatContainer.innerHTML = '';
      document.querySelectorAll('#sessionTabs div').forEach(tab => tab.classList.remove('active-session-tab'));
      if (clickedTabElement) { clickedTabElement.classList.add('active-session-tab');}
      session.forEach(msg => {
        const messageDiv = document.createElement('div');
        const timestampDiv = document.createElement('div');
        timestampDiv.className = 'chat-timestamp';
        timestampDiv.textContent = msg.timestamp;
        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = `chat-bubble ${msg.role}`;
        bubbleDiv.innerHTML = msg.content.replace(/\n/g, '<br>');
        if (msg.role === 'assistant') { messageDiv.style.alignItems = 'flex-start'; }
        else { messageDiv.style.alignItems = 'flex-end'; }
        messageDiv.appendChild(timestampDiv);
        messageDiv.appendChild(bubbleDiv);
        chatContainer.appendChild(messageDiv);
      });
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }


    // --- åˆæœŸåŒ–å‡¦ç† (å¤‰æ›´ãªã—) ---
    window.onload = () => { showSection('settings', document.querySelector('.sidebar-menu li a[href="#settings"]')); };

    // --- Drive Push Notification (å¤‰æ›´ãªã—) ---
    async function toggleWatch(evt, fileId) { const btn = event?.target; if(btn && btn.classList.contains('watch-btn')){ btn.classList.toggle('on'); btn.classList.toggle('off');} try { const res = await fetch(`${apiUrlBase}/api/watch_sheet`, { method: "POST", credentials: "include", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ file_id: fileId }) }); const data = await res.json(); alert(data.message || (res.ok ? "æ“ä½œæˆåŠŸ" : "æ“ä½œå¤±æ•—")); loadSources(); } catch (e) { console.error(e); alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e); } }
    async function previewSheet(fileId) { try { const res = await fetch(`${apiUrlBase}/api/sheet_rows`, { method: "POST", credentials: "include", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ file_id: fileId }) }); const data = await res.json(); if (data.status !== "ok") { alert(data.message || "å–å¾—å¤±æ•—"); return; } sourceDetailTitle.textContent = `ã‚·ãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${fileId}`; sourceDetailContent.innerHTML = ""; const tbl = document.createElement("table"); tbl.className = "table table-sm table-striped"; const mkRow = arr => { const tr = document.createElement("tr"); arr.forEach(c => { const td = document.createElement("td"); td.textContent = c; tr.appendChild(td); }); return tr; }; if (data.headers.length) tbl.appendChild(mkRow(data.headers)); data.rows.forEach(r => tbl.appendChild(mkRow(r))); sourceDetailContent.appendChild(tbl); sourceDetailArea.style.display = 'block'; } catch (e) { console.error(e); alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e); } }

    // --- Slack Integration (å¤‰æ›´ãªã—) ---
    async function startSlackOAuth(){ const msgArea = document.getElementById("slackIntegrationMessage"); showMessage(msgArea, "Slack æ¥ç¶šãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ã„ã¾ã™â€¦", "info", 0); try { const res  = await fetch(`${apiUrlBase}/api/slack/auth_url`, { credentials: "include" }); const data = await res.json(); if (res.ok && data.status === "ok" && data.auth_url) { window.open(data.auth_url, "_blank"); showMessage( msgArea, "ãƒ–ãƒ©ã‚¦ã‚¶ã§ Slack èªå¯ç”»é¢ã‚’é–‹ãã¾ã—ãŸã€‚è¨±å¯å¾Œã«ã“ã®ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚", "success" ); setTimeout(loadSlackStatus, 8000); } else { showMessage(msgArea, data.message || "URLå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ", "error"); } } catch (e) { console.error("Slack OAuth Error:", e); showMessage(msgArea, `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${e}`, "error"); } }
    async function loadSlackStatus(){ try{ const res = await fetch(`${apiUrlBase}/api/slack/status`, {credentials:"include"}); const data = await res.json(); const badge = document.getElementById("slackStatusBadge"); if(!badge) return; if(res.ok && data.status==="ok" && data.connected){ badge.textContent = "æ¥ç¶šæ¸ˆã¿"; badge.style.background = "#4e73df"; badge.style.color = "#fff"; }else{ badge.textContent = "æœªæ¥ç¶š"; badge.style.background = "#e0e0e0"; badge.style.color = "#555"; }}catch(e){ console.error("Slack status error:", e); }}

    // â–¼â–¼â–¼ Google Cookie ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢æ•° â–¼â–¼â–¼
    async function uploadGoogleCookieFile() {
        const fileInput = document.getElementById('googleCookieFileInput');
        const file = fileInput.files[0];

        if (!file) {
            showMessage(googleCookieMessageArea, 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
            return;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ãƒã‚§ãƒƒã‚¯ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã ãŒæ¨å¥¨)
        if (!file.name.endsWith('.txt') && !file.name.endsWith('.json')) {
            showMessage(googleCookieMessageArea, 'è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ (.txt ã¾ãŸã¯ .json ã®ã¿)ã€‚', 'error');
            return;
        }

        showMessage(googleCookieMessageArea, 'Cookieãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'info', 0);
        const formData = new FormData();
        formData.append('cookie_file', file); // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®APIãŒå—ã‘å–ã‚‹ã‚­ãƒ¼åã«åˆã‚ã›ã‚‹

        try {
            const res = await fetch(`${apiUrlBase}/api/google/upload_cookies`, { // æ–°ã—ã„APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
                method: 'POST',
                body: formData,
                credentials: 'include' // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼æƒ…å ±ã‚’å«ã‚ã‚‹
            });
            const data = await res.json();

            if (res.ok && data.status === 'ok') {
                showMessage(googleCookieMessageArea, data.message || 'Cookieãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚', 'success');
                fileInput.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            } else {
                showMessage(googleCookieMessageArea, `ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${data.message || res.statusText || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`, 'error');
            }
        } catch (error) {
            showMessage(googleCookieMessageArea, `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error}`, 'error');
            console.error("Google Cookie Upload Error:", error);
        }
    }
    // â–²â–²â–² Google Cookie ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢æ•° â–²â–²â–²

  </script>
</body>
</html>